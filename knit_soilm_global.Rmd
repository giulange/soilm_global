---
title: "SOILM_GLOBAL"
author: "Beni Stocker"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
header-includes:
   - \usepackage{amsmath}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This RMarkdown file is compiled with code from the publicly accessible github repository [github.com/stineb/soilm_global](https://github.com/stineb/soilm_global).

The starting point of this analysis is that we found that all the remote sensing-driven GPP models that we looked at have a tendency to overestimate GPP during conditions when soils are dry. Apparently, the apparent fractional reduction in light use efficiency, fLUE, which I derived in the previous paper using artificial neural networks, is strongly related - both in magnitude and timing - to the model biases. Below, I'm showing this, derive an empirical correction factor to account for soil moisture limitation on GPP, and assess implications of this mechanism for global GPP variability. 

## **The problem**: high bias in simulated GPP under dry conditions

### Pooled data from all available sites

First, collect FLUXNET 2015 data, environmental forcing data and P-model output into a common dataframe. This performs a data "cleaning" of FLUXNET 2015 data (see `clean_fluxnet.R`), calculates additional variables (e.g. soilm_obs_mean) and writes all data as an R data frame (tibble, `data/df_modobs_<simsuite>_*.Rdata`).
```{r get_modobs, echo=FALSE}
source("get_modobs.R")
simsuite <- "fluxnet2015"
outputset <- c( "s16" )
if (!file.exists( paste0( "data/df_modobs_fluxnet2015_", paste( outputset, collapse="_"), "_with_SWC_v5.Rdata" ) ) ) get_modobs( simsuite = simsuite, outputset = outputset )
```

<!-- Then, combine this with GPP data from BESS, VPM, MODIS and MTE, and aggregate all site data into a single dataframe (tibble, `data/nice_all_agg.Rdata` for daily data, and `data/nice_all_8d_agg_.Rdata` for data aggregated to 8 days). -->
<!-- ```{r aggregate_all, warning=FALSE, eval=FALSE} -->
<!-- source("aggregate_all_fluxnet2015.R") -->
<!-- ``` -->

<!-- After pooling all data and calculating the bias of simulated GPP from different products (P-model, MODIS MOD17A2H GPP, FLUXCOM MTE) as the ratio of modelled over observed, the problem becomes evident (see boxplots below). There is a systematic relationship between the bias and soil dryness. This ratio is always higher under dry conditions (daily AET/PET>0.5) than under well-watered. It's a bit weird for FLUXCOM MTE and MODIS, where there is a substantial negative bias under well-watered conditions, but no bias under dry conditions - just all shifted to too low simulated GPP. The P-model is better behaved, having no bias under well-watered conditions, but a tendency to an increasingly high positive bias with declining daily AET/PET and soil moisture values (calculated using the SPLASH model).  The same is true for MTE and MODIS GPP, although the pattern is not as clear (not shown). Here the P-model is driven using EVI for quantifying fAPAR. This is arguably implausible. We are working on a re-calibration of the light utilisation parameter in the P-model in combination with actual fAPAR data which has generally higher values than EVI. -->
<!-- ```{r plot_all, fig.width=5, fig.height=4, eval=TRUE, message=FALSE, warning=FALSE} -->
<!-- source("plot_bias_all.R") -->
<!-- ``` -->

### Pooled data from soil moisture focus sites

For a subset of the FLUXNET Tier 1 sites, a clear soil moisture control on light use efficiency is evident from the parallel CO2 flux, VPD, and and soil moisture data. These sites were used in Stocker et al. (2018) *New Phytologist* and allow us here to investigate the bias in GPP model predictions to be related to the degree of soil moisture limitation. The latter is quantified by fLUE, the fractional of light use efficiency reduction due to soil moisture.

First, aggregate data for the subset of these 71 sites only. This also reads originally downloaded MODIS GPP files and saves data for each site as Rdata files.
```{r aggregate_nn, warning=FALSE, eval=FALSE}
source("aggregate_nn_fluxnet2015.R")
```

Then align data along the start of "fLUE droughts". This also aggregates across drought events for each site and thereby quantifies the mean course of variables through drought events (not shown). Furthermore, this retains only datapoints that are either 20 days before the onset of a drought or during droughts and thereby allows us to focus on model bias associated with soil dryness. This uses only data with successcode 1, i.e. where a certain minimum number of days in the data were classified as *fLUE drought* in Stocker et al. (subm.).
```{r align, warning=FALSE, eval=FALSE}
source("execute_reshape_align_nn_fluxnet2015.R")
```
For all GPP models, this shows a clear relationship between the apparent fractional reduction in light use efficiency (fLUE) and the model bias. Here, the ratio of observed-to-modelled is shown along the y-axes, indicating by how much modelled GPP would have to be scaled in order to match observations.  The straight red line is the 1:1 line and the fact that points cluster along it indicates that soil moisture effects on LUE are the dominant factor underlying model bias. Colors indicate the density of points. Small boxes with horizontal red lines show the most frequent value from a kernel density within fLUE bins and the vertical extent of the boxes the range of values where the kernel density lies above half its peak. The boxes to the right of each plot represent model bias (median, IQR) during the 20 days before fLUE drought onset.

```{r plot_bias, eval=FALSE, message=FALSE, warning=FALSE}
source("plot_bias_nn.R")
```
![*Bias vs. fLUE*](./fig/bias_vs_fvar.pdf)

## **The solution**: Fitting an empirical soil moisture stress function
As documented above, there is a systematic bias of several remote-sensing based GPP models during droughts and this bias is strongly related, both in magnitude and timing, to the apparent effects of soil moisture on light use efficiency. These apparent effects are quantified by 'fLUE', derived with artificial neural networks as described in Stocker et al. (2018). In addition, we found in Stocker et al. (2018) that the sensitivity of LUE to progressive soil dryness is related to the mean aridity at the site. I.e., the dryness-related decline in LUE is particularly strong at the driest sites (mostly deserts, grasslands, savannahs), whereas sites at intermediate aridity (mostly mediterranean) exhibit a smaller maximum reduction in LUE.

The functional form of fLUE (here termed $\varphi$) versus soil moisture ($\theta$) is suggestive of a quadratic function that attains 1 for soil moisture above a certain threshold $\theta_0$ and held at 1 for soil moisture values above that (see Fig. 7 in Stocker et al., 2018), and has a y-axis intersect ($\varphi_0$) related to mean annual AET/PET, (see Fig. 7 in Stocker et al., 2018). The latter reflects the relationship between soil dryness sensitivity of LUE and mean aridity of the site. Hence, the soil moisture stress function ($\varphi(\theta)$) can be described by:
$$
    \varphi =
\begin{cases}
    \beta(\theta - \theta_0)^2 + 1,& \theta \leq \theta_0\\
    1,              & \theta > \theta_0
\end{cases}
$$
where the "curvature coefficient" $\beta$ is defined by the maximum LUE reduction ($\varphi_0$) at low soil moisture ($\theta$=0), leading to $\beta=(\varphi_0-1)/\theta_0^2$. $\varphi_0$ is a linear function of the mean annual AET/PET, termed $\alpha$:
$$
\varphi_0 = a + b \alpha
$$

Here, I'm using these relationships to fit an empirical function that represents direct soil moisture effects on LUE.

I tested several approaches to fit parameters $a$ and $b$. Best results were obtained by prescribing $\theta_0$ to 0.9 based on visual inspection of the functional form $\varphi(\theta)$ in Fig. 7 of Stocker et al. (2018). After countless tests of alternative approaches to define parameters $a$ and $b$, I show below three approaches that lead to soil moisture stress function that bracket fLUE values derived at different sites. Below is a description of the three approaches and their effect for resolving the bias of the P-model.

### Approach I

Based on fLUE in lowest soil moisture bin and its relationship to mean AET/PET.

This uses the relationship between minimum fLUE and mean AET/PET, identified in Stocker et al. (2018). Parameters $a$ and $b$ are calculated from a linear regression between each site's $\varphi_0$ and $\alpha$ (mean annual AET/PET, calculated from daily values of simulations with the SPLASH model). $\varphi_0$ is derived for each site as the mean fLUE value of data in the lowest soil moisture quartile. This defines parameters $a$ and $b$, and hence $\beta$ in above equations. This is identical to the linear regression of fLUE$_0$ to soil moisture shown in Stocker et al. (2018) Fig. 9.
```{r linearfit1a, message=FALSE, warning=FALSE, echo=FALSE}
library(dplyr)
load( "data/data_aligned_agg.Rdata" )     # loads 'df_dday_agg', etc.
ddf <- df_dday_agg
rm("df_dday_agg")  # rename to be a bit more concise

## Use only sites where NN method worked (i.e. that had clear and identifiable soil moisture limitation)
successcodes <- read.csv( paste0( myhome, "/sofun/utils_sofun/analysis_sofun/fluxnet2015/successcodes.csv" ), as.is = TRUE )
do.sites <- dplyr::filter( successcodes, successcode==1 | successcode==2 )$mysitename
ddf <- ddf %>% filter( mysitename %in% do.sites )

## Merge mean annual alpha (AET/PET) values into this dataframe
load( "../sofun/utils_sofun/analysis_sofun/fluxnet2015/data/alpha_fluxnet2015.Rdata" )  # loads 'df_alpha'
ddf <- ddf %>% left_join( rename( df_alpha, meanalpha=alpha ), by="mysitename" )
source("get_linearfit.R")
source("plot_linearfit.R")

linearfit1  <- get_linearfit( filter( ddf, ratio_obs_mod_pmodel < 5 ), monthly=FALSE )
save( linearfit1,  file="data/linearfit1.Rdata" )
plot_linearfit( linearfit1 )
```

In summary, this method derives the following fitting parameters:
```{r}
print( coef(linearfit1$linmod) )
df_coef <- tibble( approach="I", apar=coef(linearfit1$linmod)["(Intercept)"], bpar=coef(linearfit1$linmod)["meanalpha"], apar_grass=NA, bpar_grass=NA )
```

Given the estimate of $\varphi_0$ as a function of $\alpha$ at each site, we can calculate the soil moisture stress function using daily varying soil moisture data and evaluate whether accounting for this resolves the bias of modelled GPP at low soil moisture. Here, I'm assessing this with GPP predictions from the P-model.
```{r correct_linearfit1a, message=FALSE, warning=FALSE, echo=FALSE}
source("calc_flue_est_alpha.R")

## add estimated fLUE to ddf
ddf <- ddf %>%  mutate( flue_est_I = calc_flue_est_alpha( soilm_mean, alpha=meanalpha, apar=coef(linearfit1$linmod)[1], bpar=coef(linearfit1$linmod)[2], cpar=0.125, dpar=0.75 ) ) %>% 
                          mutate( bias_pmodel_diff = gpp_pmodel - gpp_obs,
                                  bias_pmodel_diff_corr = gpp_pmodel * fvar - gpp_obs,
                                  bias_pmodel_diff_corr_I = gpp_pmodel * flue_est_I - gpp_obs
                                 )

## evaluate bias~soil moisture
nbins <- 4
binwidth <- 1/nbins
bins <- seq( from=0, to=1, by=binwidth )
ddf <- ddf %>% mutate( inbin = cut( as.numeric(soilm_mean), breaks = bins ) )

## Bias (difference), correction by fLUE directly, fLUE bins
bp1 <- boxplot( bias_pmodel_diff ~ inbin, data=ddf, col="tomato", las=1, outline = FALSE, na.rm=TRUE, add=FALSE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.1), boxwex=0.03, xlim=c(0,1), xlab="soilm moisture bins", ylab="bias (mod.-obs.)", staplewex=0, whisklty=1, ylim=c(-6,6) )
bp2 <- boxplot( bias_pmodel_diff_corr_I ~ inbin, data=ddf, col="springgreen3", las=1, outline = FALSE, na.rm=TRUE, add=TRUE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.3), boxwex=0.03, xlim=c(0,1), axes=FALSE, staplewex=0, whisklty=1, ylim=c(-6,6) )
bp3 <- boxplot( bias_pmodel_diff_corr ~ inbin, data=ddf, col="springgreen4", las=1, outline = FALSE, na.rm=TRUE, add=TRUE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.5), boxwex=0.03, xlim=c(0,1), axes=FALSE, staplewex=0, whisklty=1, ylim=c(-6,6) )
abline( h=0.0, lty=3 )
legend("bottomleft", c("P-model", "P-model, corrected by I", "P-model, corrected by fLUE"), bty="n", fill=c("tomato", "springgreen3", "springgreen4") )
```

Above boxplot shows that the bias in predicted GPP is reduced but not resolved. Apparently, the predicted LUE reduction at low soil moisture is generally not strong enough.

Here, the boxplot for fLUE bins suggests that the bias is stronger than when looking at the boxplot for soil moisture bins.


### Approach II

Based on fitted relationship between fLUE and soil moisture, taking its y-axis intersect and its relationship to mean AET/PET.

In contrast to the method above, I'm fitting parameters $a$ and $b$ not to the maximum fLUE reduction, but to the bias in modelled versus observed GPP (for the P-model), i.e. to the ratio of observed over modelled GPP as a function of soil moisture. First, a quadratic function of the form described above (Eq. XXX) is fitted to the ratio of observed versus modelled GPP for each site individually. This yields a site-specific relationship of model bias with soil moisture and defines the maximum LUE reduction (or LUE correction) at low soil moisture ($\varphi_0$) for each site. Second, $\varphi_0$ is regressed against $\alpha$ as above.

```{r get_linearfit2, warning=FALSE, message=FALSE, echo=FALSE}
## load additional functions
source("get_linearfit2.R")
source("stress_quad_1sided.R")

## Use fixed point (soil moisture) above which stress function is 1 (no stress)
x0_fix <- 0.9
linearfit2 <- get_linearfit2( filter( ddf, dday>=0 ), target="fvar", monthly=FALSE, bin=FALSE, x0_fix=x0_fix, useweights = TRUE, doplot = FALSE )
save( linearfit2, file="data/linearfit2_ratio.Rdata" )
df_coef <- df_coef %>% bind_rows( tibble( approach="II", apar=coef(linearfit2$linmod)["(Intercept)"], bpar=coef(linearfit2$linmod)["meanalpha"], apar_grass=NA, bpar_grass=NA ))
```

Again, we have a linear relationship between the maximum LUE reduction (y-axis intersect) and mean site aridity (AET/PET).
```{r}
par(las=1)
with(linearfit2$data, plot( meanalpha, y0, pch=16 ) )
abline( linearfit2$linmod )
mtext( line=-1.5, bquote( italic(R)^2 == .(format( summary( linearfit2$linmod )$r.squared, digits = 2) ) ),  adj=0.1, cex=1 )
cf <- coef(linearfit2$linmod) %>% round( 2 )
eq <- paste0( "y = ", cf[1], ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " x " )
mtext( line=-2.5, eq, adj=0.1 )
```

This approach (II) effectively resolves the bias in P-model GPP predictions even at very low soil moisture, as shown by the boxplots below (logarithm of observed over modelled in soil moisture bins).
```{r correct_linearfit2_boxpl, warning=FALSE, message=FALSE, echo=FALSE}
## add estimated fLUE to ddf
ddf <- ddf %>%  mutate( flue_est_II = stress_quad_1sided_alpha( soilm_mean, meanalpha, x0_fix, coef(linearfit2$linmod)[["(Intercept)"]], coef(linearfit2$linmod)[["meanalpha"]] ) ) %>% 
                mutate( bias_pmodel_diff_corr_II = gpp_pmodel * flue_est_II - gpp_obs )

## Bias (difference), correction by fLUE directly, fLUE bins
bp1 <- boxplot( bias_pmodel_diff ~ inbin, data=ddf, col="tomato", las=1, outline = FALSE, na.rm=TRUE, add=FALSE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.1), boxwex=0.03, xlim=c(0,1), xlab="soilm moisture bins", ylab="bias (mod.-obs.)", staplewex=0, whisklty=1, ylim=c(-6,6) )
bp2 <- boxplot( bias_pmodel_diff_corr_II ~ inbin, data=ddf, col="springgreen3", las=1, outline = FALSE, na.rm=TRUE, add=TRUE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.3), boxwex=0.03, xlim=c(0,1), axes=FALSE, staplewex=0, whisklty=1, ylim=c(-6,6) )
bp3 <- boxplot( bias_pmodel_diff_corr ~ inbin, data=ddf, col="springgreen4", las=1, outline = FALSE, na.rm=TRUE, add=TRUE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.5), boxwex=0.03, xlim=c(0,1), axes=FALSE, staplewex=0, whisklty=1, ylim=c(-6,6) )
abline( h=0.0, lty=3 )
legend("bottomleft", c("P-model", "P-model, corrected by II", "P-model, corrected by fLUE"), bty="n", fill=c("tomato", "springgreen3", "springgreen4") )
```

In summary, this method derives the following fitting parameters:
```{r}
print( coef(linearfit2$linmod) )
```

This is the R code that implements this soil moisture stress function:
```{r empirical_function, eval=FALSE}
stress_quad_1sided_alpha <- function( x, alpha, x0, apar, bpar ){
	y0 <- apar + bpar * alpha
	beta <- (1 - y0) / x0^2
  outstress <- 1.0 - beta * ( x - x0 ) ^ 2
  outstress <- ifelse( x>x0, 1, ifelse( x<0, 0, outstress ) )
  outstress <- ifelse( outstress>1, 1, ifelse( outstress<0, 0, outstress ) )
  return( outstress )
}
```
Here, `x0` is set to 0.9. `alpha` is $\alpha$ (AET/PET, mean over daily values per site), and `x` is soil moisture.

### Approach III

As II, but for notorious sites.

In contrast to the method above, I'm fitting parameters $a$ and $b$ not to the maximum fLUE reduction, but to the bias in modelled versus observed GPP (for the P-model), i.e. to the ratio of observed over modelled GPP as a function of soil moisture. First, a quadratic function of the form described above (Eq. XXX) is fitted to the ratio of observed versus modelled GPP for each site individually. This yields a site-specific relationship of model bias with soil moisture and defines the maximum LUE reduction (or LUE correction) at low soil moisture ($\varphi_0$) for each site. Second, $\varphi_0$ is regressed against $\alpha$ as above.

```{r get_linearfit3, warning=FALSE, message=FALSE, echo=FALSE}
## Use fixed point (soil moisture) above which stress function is 1 (no stress)
x0_fix <- 0.9
notorious <- c("IT-Noe", "FR-Pue", "AU-Stp", "AU-Fog", "AU-DaP", "AU-ASM", "IT-SRo", "US-SRG", "US-SRM", "US-Var") 
linearfit3 <- get_linearfit2( filter( ddf, dday>=0, mysitename %in% notorious ), target="fvar", monthly=FALSE, bin=FALSE, x0_fix=x0_fix, useweights = TRUE, doplot = FALSE )
save( linearfit3, file="data/linearfit2_ratio.Rdata" )
df_coef <- df_coef %>% bind_rows( tibble( approach="III", apar=coef(linearfit3$linmod)["(Intercept)"], bpar=coef(linearfit3$linmod)["meanalpha"], apar_grass=NA, bpar_grass=NA ))
```

This approach (II) effectively resolves the bias in P-model GPP predictions even at very low soil moisture, as shown by the boxplots below (logarithm of observed over modelled in soil moisture bins).
```{r correct_linearfit3_boxpl, warning=FALSE, message=FALSE, echo=FALSE}
## add estimated fLUE to ddf
ddf <- ddf %>%  mutate( flue_est_III = stress_quad_1sided_alpha( soilm_mean, meanalpha, x0_fix, coef(linearfit3$linmod)[["(Intercept)"]], coef(linearfit3$linmod)[["meanalpha"]] ) ) %>% 
                mutate( bias_pmodel_diff_corr_III = gpp_pmodel * flue_est_III - gpp_obs )

## Bias (difference), correction by fLUE directly, fLUE bins
bp1 <- boxplot( bias_pmodel_diff ~ inbin, data=ddf, col="tomato", las=1, outline = FALSE, na.rm=TRUE, add=FALSE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.1), boxwex=0.03, xlim=c(0,1), xlab="soilm moisture bins", ylab="bias (mod.-obs.)", staplewex=0, whisklty=1, ylim=c(-6,6) )
bp2 <- boxplot( bias_pmodel_diff_corr_III ~ inbin, data=ddf, col="springgreen3", las=1, outline = FALSE, na.rm=TRUE, add=TRUE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.3), boxwex=0.03, xlim=c(0,1), axes=FALSE, staplewex=0, whisklty=1, ylim=c(-6,6) )
bp3 <- boxplot( bias_pmodel_diff_corr ~ inbin, data=ddf, col="springgreen4", las=1, outline = FALSE, na.rm=TRUE, add=TRUE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.5), boxwex=0.03, xlim=c(0,1), axes=FALSE, staplewex=0, whisklty=1, ylim=c(-6,6) )
abline( h=0.0, lty=3 )
legend("bottomleft", c("P-model", "P-model, corrected by III", "P-model, corrected by fLUE"), bty="n", fill=c("tomato", "springgreen3", "springgreen4") )
```

### Approach IV

Separate fit for grasslands and others, otherwise identical to approach II

```{r get_linearfit6, warning=FALSE, message=FALSE, echo=FALSE}
## Merge IGBP class ID into dataframe
require(readr)
siteinfo <- read_csv("../sofun/input_fluxnet2015_sofun/siteinfo_fluxnet2015_sofun.csv")
ddf <- ddf %>% select( -starts_with("classid")) %>% left_join( select( siteinfo, mysitename, classid ), by = "mysitename" )

## load additional functions
source("get_linearfit6.R")
source("stress_quad_1sided.R")

## Use fixed point (soil moisture) above which stress function is 1 (no stress)
x0_fix <- 0.9
linearfit6 <- get_linearfit6( filter( ddf, dday >=0 & !(mysitename %in% c("CH-Oe1", "US-Var")) ), target="fvar", monthly=FALSE, bin=FALSE, x0_fix=x0_fix, useweights = TRUE, doplot = FALSE )
save( linearfit6, file="data/linearfit6_ratio.Rdata" )
df_coef <- df_coef %>% bind_rows( tibble( approach="IV", apar=coef(linearfit6$linmod_tree)["(Intercept)"], bpar=coef(linearfit6$linmod_tree)["meanalpha"], apar_grass=coef(linearfit6$linmod_grass)["(Intercept)"], bpar_grass=coef(linearfit6$linmod_grass)["meanalpha"] ))
```

Again, we have a linear relationship between the maximum LUE reduction (y-axis intersect) and mean site aridity (AET/PET).
```{r}
par(las=1)
with( filter( linearfit6$data, classid %in% c("GRA", "CSH")), plot( meanalpha, y0, pch=16 , ylim=c(0,1), xlim=c(0,1)) )
with( filter( linearfit6$data, !(classid %in% c("GRA", "CSH"))), points( meanalpha, y0, pch=1 ) )
abline( linearfit6$linmod_grass )
abline( linearfit6$linmod_tree, lty=2 )
mtext( line=-1.5, bquote( italic(R)^2 == .(format( summary( linearfit6$linmod_grass )$r.squared, digits = 2) ) ),  adj=0.1, cex=1 )
cf <- coef(linearfit6$linmod_grass) %>% round( 2 )
eq <- paste0( "y = ", cf[1], ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " x " )
mtext( line=-2.5, eq, adj=0.1 )
```

<!-- This generally leads to a stronger sensitivity to soil moisture across the whole aridity spectrum. Compare to the solid line to dashed line, where the solid line represents the regression from approach II and the dashed line from approach I. -->
<!-- ```{r plot_linearfit2_ratio, warning=FALSE, message=FALSE, echo=FALSE} -->
<!-- source("plot_linearfit2.R") -->
<!-- load("data/linearfit1.Rdata") -->

<!-- ## plot fLUE0 vs. mean alpha and functional relationship (data cloud and fitted line) for all sites. -->
<!-- # plot_linearfit2( linearfit2, linearfit1, df=ddf ) -->
<!-- ``` -->


```{r correct_linearfit6, warning=FALSE, message=FALSE, echo=FALSE}
source("stress_quad_1sided.R")
apar <- c( coef(linearfit6$linmod_tree)[["(Intercept)"]], coef(linearfit6$linmod_grass)[["(Intercept)"]] )
bpar <- c( coef(linearfit6$linmod_tree)[["meanalpha"]], coef(linearfit6$linmod_grass)[["meanalpha"]] )

## add estimated fLUE to ddf
ddf$flue_est_IV <- rep( NA, nrow( ddf ))
for (idx in seq(nrow(ddf))){
  ddf$flue_est_IV[idx] <- stress_quad_1sided_alpha_grasstree( ddf$soilm_mean[idx], ddf$meanalpha[idx], x0 = 0.9, apar, bpar, ddf$classid[idx] )
}
ddf <- ddf %>% mutate( bias_pmodel_diff_corr_IV = gpp_pmodel * flue_est_IV - gpp_obs )

## Bias (difference), correction by fLUE directly, fLUE bins
bp1 <- boxplot( bias_pmodel_diff ~ inbin, data=ddf, col="tomato", las=1, outline = FALSE, na.rm=TRUE, add=FALSE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.1), boxwex=0.03, xlim=c(0,1), xlab="soilm moisture bins", ylab="bias (mod.-obs.)", staplewex=0, whisklty=1, ylim=c(-6,6) )
bp2 <- boxplot( bias_pmodel_diff_corr_IV ~ inbin, data=ddf, col="springgreen3", las=1, outline = FALSE, na.rm=TRUE, add=TRUE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.3), boxwex=0.03, xlim=c(0,1), axes=FALSE, staplewex=0, whisklty=1, ylim=c(-6,6) )
bp3 <- boxplot( bias_pmodel_diff_corr ~ inbin, data=ddf, col="springgreen4", las=1, outline = FALSE, na.rm=TRUE, add=TRUE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.5), boxwex=0.03, xlim=c(0,1), axes=FALSE, staplewex=0, whisklty=1, ylim=c(-6,6) )
abline( h=0.0, lty=3 )
legend("bottomleft", c("P-model", "P-model, corrected by IV", "P-model, corrected by fLUE"), bty="n", fill=c("tomato", "springgreen3", "springgreen4") )
```


### Linearfit V: Exponential stress function

```{r get_linearfit5, warning=FALSE, message=FALSE, echo=FALSE}
## load additional functions
source("get_linearfit5.R")

## Use fixed point (soil moisture) above which stress function is 1 (no stress)
x0_fix <- 0.9
linearfit5 <- get_linearfit5( filter( ddf, dday>=0, mysitename!="CH-Oe1" ), target="fvar", monthly=FALSE, bin=FALSE, x0_fix=x0_fix, useweights = TRUE, doplot = FALSE )
save( linearfit5, file="data/linearfit5.Rdata" )
df_coef <- df_coef %>% bind_rows( tibble( approach="V", apar=coef(linearfit5$linmod_y0_tree)["(Intercept)"], bpar=coef(linearfit5$linmod_y0_tree)["meanalpha"], apar_grass=coef(linearfit5$linmod_y0_grass)["(Intercept)"], bpar_grass=coef(linearfit5$linmod_y0_grass)["meanalpha"] ))
```

What sort of relationships do we see between `y0` and aridity or vegetation type?

Again, we have a linear relationship between the maximum LUE reduction (y-axis intersect) and mean site aridity (AET/PET).
```{r}
par(las=1)
with(filter(linearfit5$data, classid!="GRA"), plot( meanalpha, y0, pch=1, ylim=c(0,1) ) )
with(filter(linearfit5$data, classid=="GRA"), points( meanalpha, y0, pch=16 ) )
abline( linearfit5$linmod_y0_tree, lty=2 )
abline( linearfit5$linmod_y0_grass )
mtext( line=-1.5, bquote( italic(R)^2 == .(format( summary( linearfit5$linmod_y0_tree )$r.squared, digits = 2) ) ),  adj=0.1, cex=1 )
cf <- coef(linearfit5$linmod_y0_tree) %>% round( 2 )
eq <- paste0( "y = ", cf[1], ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " x " )
mtext( line=-2.5, eq, adj=0.1 )
```

And (a somewhat weaker) relationship between the mean aridity and the curvature parameter.
```{r}
par(las=1)
# with( linearfit5$data, plot( y0, curve, pch=16 ) )
with( linearfit5$data, plot( meanalpha, curve, pch=16 ) )
abline( linearfit5$linmod_curve )
mtext( line=-1.5, bquote( italic(R)^2 == .(format( summary( linearfit5$linmod_curve )$r.squared, digits = 2) ) ),  adj=0.1, cex=1 )
cf <- coef(linearfit5$linmod_curve) %>% round( 2 )
eq <- paste0( "y = ", cf[1], ifelse(sign(cf[2])==1, " + ", " - "), abs(cf[2]), " x " )
mtext( line=-2.5, eq, adj=0.1 )
```

Let's see how this works...
```{r correct_linearfit5, warning=FALSE, message=FALSE, echo=FALSE}
source("stress_exp.R")

apar <- c( coef(linearfit5$linmod_y0_tree)[["(Intercept)"]], coef(linearfit5$linmod_y0_grass)[["(Intercept)"]] )
bpar <- c( coef(linearfit5$linmod_y0_tree)[["meanalpha"]], coef(linearfit5$linmod_y0_grass)[["meanalpha"]] )

## add estimated fLUE to ddf
ddf$flue_est_V  <- rep( NA, nrow( ddf ))
for (idx in seq(nrow(ddf))){
  ddf$flue_est_V[idx]  <- stress_exp_alpha_grasstree( ddf$soilm_mean[idx], ddf$meanalpha[idx], apar, bpar, coef(linearfit5$linmod_curve)[1], coef(linearfit5$linmod_curve)[2], classid=ddf$classid[idx] )
}

ddf <- ddf %>% mutate( bias_pmodel_diff_corr_V = gpp_pmodel * flue_est_V - gpp_obs )

## Bias (difference), correction by fLUE directly, fLUE bins
bp1 <- boxplot( bias_pmodel_diff ~ inbin, data=ddf, col="tomato", las=1, outline = FALSE, na.rm=TRUE, add=FALSE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.1), boxwex=0.03, xlim=c(0,1), xlab="soilm moisture bins", ylab="bias (mod.-obs.)", staplewex=0, whisklty=1, ylim=c(-6,6) )
bp2 <- boxplot( bias_pmodel_diff_corr_V ~ inbin, data=ddf, col="springgreen3", las=1, outline = FALSE, na.rm=TRUE, add=TRUE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.3), boxwex=0.03, xlim=c(0,1), axes=FALSE, staplewex=0, whisklty=1, ylim=c(-6,6) )
bp3 <- boxplot( bias_pmodel_diff_corr ~ inbin, data=ddf, col="springgreen4", las=1, outline = FALSE, na.rm=TRUE, add=TRUE, staplewex=0, whisklty=1, at=(bins[1:nbins]+1/nbins*0.5), boxwex=0.03, xlim=c(0,1), axes=FALSE, staplewex=0, whisklty=1, ylim=c(-6,6) )
abline( h=0.0, lty=3 )
legend("bottomleft", c("P-model", "P-model, corrected by V", "P-model, corrected by fLUE"), bty="n", fill=c("tomato", "springgreen3", "springgreen4") )
```

### Overview

```{r echo = FALSE, results = 'asis', warning=FALSE}
library(knitr)
kable(df_coef, caption = "Overview of parameters determining y0 as a function of site aridity.")
```

## Site-by-site evaluations

Site-by-site evaluations of the three different soil moisture stress functions are shown below.

### Stress vs. soil moisture

```{r plot_site_vs_soilmoisture}
source("plot_fit_vs_soilmoist.R")
plot_fit_vs_soilmoist( linearfit1, linearfit6, linearfit3, ddf, nice_agg, makepdf = FALSE )
```

### Stress and fLUE vs. time

```{r plot_site_fit_fvar_vs_time}
source("plot_fit_fvar_vs_time.R")
load("data/nice_nn_agg_lue_obs_evi.Rdata")
plot_fit_fvar_vs_time( linearfit1, linearfit6, linearfit3, ddf, nice_agg, makepdf = TRUE )
```

### GPP, P-model original and corrected

```{r plot_site_fit_gpp_vs_time}
source("plot_fit_gpp_vs_time.R")
plot_fit_gpp_vs_time( linearfit1, linearfit6, linearfit3, ddf, nice_agg, makepdf=TRUE )
```


## Universal stress function?

### Bias, by models
We've seen that all RS-models exhibit a bias towards overestimating GPP at low soil moisture. The regression of this bias against fLUE reveals a consistent relationship that holds for all RS-models.
```{r}
## Load aligned aggregated data
load( "data/data_aligned_agg.Rdata" )

## IMPORTANT: REMOVE DUPLICATE ROWS (were introduced because one date can below to multiple drought instances (within their before-after window) )
df_dday_agg    <- df_dday_agg    %>% select( -dday, -inst ) %>% unique()
df_dday_8d_agg <- df_dday_8d_agg %>% select( -dday, -inst ) %>% unique()


df_dday_8d_agg <- filter( df_dday_8d_agg, mysitename!="US-Var")

##------------------------------------------------
## bin data
##------------------------------------------------
## define fLUE bins
nbins <- 5
max <- 1.0
binwidth <- max/nbins
bins <- seq( from=0, to=max, by=binwidth )
xvals <- bins[1:nbins]+binwidth/2

df_dday_8d_agg <- df_dday_8d_agg %>% mutate( inbin = cut( fvar, breaks = bins ) )

##------------------------------------------------
## Quick plots I:
##------------------------------------------------
## Bias for each model separately
## pmodel
par(las=1)
boxplot( bias_pmodel_diff ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "P-model", line=0.5, adj = 0, font=2 )

## MODIS
boxplot( bias_modis_diff ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "MODIS", line=0.5, adj = 0, font=2 )

## vpm
boxplot( bias_vpm_diff ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "VPM", line=0.5, adj = 0, font=2 )

## bess_v1
boxplot( bias_bess_v1_diff ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "BESS", line=0.5, adj = 0, font=2 )
```

### Normalised bias, by models
All RS-models (except the P-model) underestimate GPP when fLUE is high. To remove this bias, data is normalised for each model separately to the ratio of observed over modelled within the highest fLUE bin.
```{r}
##------------------------------------------------
## normalise ratios 
## to 1 for bin fvar = 1.0-1.1
##------------------------------------------------
df_binmedians <- df_dday_8d_agg %>%   group_by( inbin ) %>% 
                                      summarise( median_modis   = median( bias_modis,   na.rm = TRUE ),
                                                 median_vpm     = median( bias_vpm,     na.rm = TRUE ),
                                                 median_bess_v1 = median( bias_bess_v1, na.rm = TRUE ),
                                                 median_pmodel  = median( bias_pmodel,  na.rm = TRUE )
                                                )

df_dday_8d_agg <- df_dday_8d_agg %>%  mutate(  gpp_modis   = gpp_modis     / df_binmedians$median_modis[nbins],
                                               gpp_vpm     = gpp_vpm      / df_binmedians$median_vpm[nbins], 
                                               gpp_bess_v1 = gpp_bess_v1 / df_binmedians$median_bess_v1[nbins], 
                                               gpp_pmodel  = gpp_pmodel / df_binmedians$median_pmodel[nbins]  
                                               ) %>%
                                      mutate( bias_pmodel_diff  = gpp_pmodel  - gpp_obs,
                                              bias_modis_diff   = gpp_modis   - gpp_obs,
                                              bias_vpm_diff     = gpp_vpm     - gpp_obs,
                                              bias_bess_v1_diff = gpp_bess_v1 - gpp_obs
                                             )

##------------------------------------------------
## Quick plots II:
##------------------------------------------------
## Bias for each model separately after "normalisation"
## pmodel
boxplot( bias_pmodel_diff ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "P-model, normalised", line=0.5, adj = 0, font=2 )

## MODIS
boxplot( bias_modis_diff ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "MODIS, normalised", line=0.5, adj = 0, font=2 )

## vpm
boxplot( bias_vpm_diff ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "VPM, normalised", line=0.5, adj = 0, font=2 )

## bess_v1
boxplot( bias_bess_v1_diff ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "BESS, normalised", line=0.5, adj = 0, font=2 )
```

### Corrected, by models and stress function
Now, we apply the empirical soil moisture stress functions and check whether the systematic biases are resolved for each RS-model. First, using approach II:
```{r}
##------------------------------------------------
## correct ratio with estimated fLUE
##------------------------------------------------
library(tibble)
df_dday_8d_agg <- df_dday_8d_agg %>% as_tibble() %>%
                                     mutate(  
                                              bias_modis_diff_corr   = gpp_modis   * fvar - gpp_obs,
                                              bias_vpm_diff_corr     = gpp_vpm     * fvar - gpp_obs, 
                                              bias_bess_v1_diff_corr = gpp_bess_v1 * fvar - gpp_obs, 
                                              bias_pmodel_diff_corr  = gpp_pmodel  * fvar - gpp_obs,

                                              bias_modis_diff_corr_I   = gpp_modis   * flue_est_I - gpp_obs,
                                              bias_vpm_diff_corr_I     = gpp_vpm     * flue_est_I - gpp_obs, 
                                              bias_bess_v1_diff_corr_I = gpp_bess_v1 * flue_est_I - gpp_obs, 
                                              bias_pmodel_diff_corr_I  = gpp_pmodel  * flue_est_I - gpp_obs,

                                              bias_modis_diff_corr_II   = gpp_modis   * flue_est_II - gpp_obs,
                                              bias_vpm_diff_corr_II     = gpp_vpm     * flue_est_II - gpp_obs, 
                                              bias_bess_v1_diff_corr_II = gpp_bess_v1 * flue_est_II - gpp_obs, 
                                              bias_pmodel_diff_corr_II  = gpp_pmodel  * flue_est_II - gpp_obs,

                                              ## flue_est_IV is based on separate grasslands and others
                                              bias_modis_diff_corr_IV   = gpp_modis   * flue_est_IV - gpp_obs,
                                              bias_vpm_diff_corr_IV     = gpp_vpm     * flue_est_IV - gpp_obs, 
                                              bias_bess_v1_diff_corr_IV = gpp_bess_v1 * flue_est_IV - gpp_obs, 
                                              bias_pmodel_diff_corr_IV  = gpp_pmodel  * flue_est_IV - gpp_obs,

                                              bias_modis_diff_corr_III   = gpp_modis   * flue_est_III - gpp_obs,
                                              bias_vpm_diff_corr_III     = gpp_vpm     * flue_est_III - gpp_obs, 
                                              bias_bess_v1_diff_corr_III = gpp_bess_v1 * flue_est_III - gpp_obs, 
                                              bias_pmodel_diff_corr_III  = gpp_pmodel  * flue_est_III - gpp_obs,

                                              ## flue_est_V is based on exponential stress function
                                              bias_modis_diff_corr_V   = gpp_modis   * flue_est_V - gpp_obs,
                                              bias_vpm_diff_corr_V     = gpp_vpm     * flue_est_V - gpp_obs, 
                                              bias_bess_v1_diff_corr_V = gpp_bess_v1 * flue_est_V - gpp_obs, 
                                              bias_pmodel_diff_corr_V  = gpp_pmodel  * flue_est_V - gpp_obs
                                            )

##------------------------------------------------
## Quick plots III:
##------------------------------------------------
## Bias for each model separately after "normalisation"

## Corrected by fLUE

## pmodel
boxplot( bias_pmodel_diff_corr ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "P-model, norm., corr. fLUE", line=0.5, adj = 0, font=2 )

# library(LSD)
# with( df_dday_8d_agg, heatscatter( fvar, bias_pmodel_diff, ylim = c(-6,6), xlim = c(0,1.2) ) )
# abline( h=0, lty=3 )

# with( df_dday_8d_agg, heatscatter( fvar, bias_pmodel_diff_corr, ylim = c(-6,6), xlim = c(0,1.2) ) )
# abline( h=0, lty=3 )

# with( df_dday_8d_agg, heatscatter( fvar, bias_pmodel_diff_corr_III, ylim = c(-6,6), xlim = c(0,1.2) ) )
# abline( h=0, lty=3 )

## MODIS
boxplot( bias_modis_diff_corr ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "MODIS, norm., corr. fLUE", line=0.5, adj = 0, font=2 )

## vpm
boxplot( bias_vpm_diff_corr ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "VPM, norm., corr. fLUE", line=0.5, adj = 0, font=2 )

## bess_v1
boxplot( bias_bess_v1_diff_corr ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "BESS, norm., corr. fLUE", line=0.5, adj = 0, font=2 )


## Corrected by estimated fLUE (following approach II)

## pmodel
boxplot( bias_pmodel_diff_corr_II ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "P-model, norm., corr. II", line=0.5, adj = 0, font=2 )

## MODIS
boxplot( bias_modis_diff_corr_II ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "MODIS, norm., corr. II", line=0.5, adj = 0, font=2 )

## vpm
boxplot( bias_vpm_diff_corr_II ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "VPM, norm., corr. II", line=0.5, adj = 0, font=2 )

## bess_v1
boxplot( bias_bess_v1_diff_corr_II ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "BESS, norm., corr. II", line=0.5, adj = 0, font=2 )


## Corrected by estimated fLUE (following approach IV)

## pmodel
boxplot( bias_pmodel_diff_corr_IV ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "P-model, norm., corr. IV", line=0.5, adj = 0, font=2 )

## MODIS
boxplot( bias_modis_diff_corr_IV ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "MODIS, norm., corr. IV", line=0.5, adj = 0, font=2 )

## vpm
boxplot( bias_vpm_diff_corr_IV ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "VPM, norm., corr. IV", line=0.5, adj = 0, font=2 )

## bess_v1
boxplot( bias_bess_v1_diff_corr_IV ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "BESS, norm., corr. IV", line=0.5, adj = 0, font=2 )

## Corrected by estimated fLUE (following approach V)

## pmodel
boxplot( bias_pmodel_diff_corr_V ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "P-model, norm., corr. V", line=0.5, adj = 0, font=2 )

## MODIS
boxplot( bias_modis_diff_corr_V ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "MODIS, norm., corr. V", line=0.5, adj = 0, font=2 )

## vpm
boxplot( bias_vpm_diff_corr_V ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "VPM, norm., corr. V", line=0.5, adj = 0, font=2 )

## bess_v1
boxplot( bias_bess_v1_diff_corr_V ~ inbin, data=df_dday_8d_agg, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "BESS, norm., corr. V", line=0.5, adj = 0, font=2 )
```

### Corrected, by models, pooled stress function

```{r}
##------------------------------------------------
## Treat data from different stress functions as one - gather data
##------------------------------------------------
pmodel <- df_dday_8d_agg %>%  select( mysitename, date, inbin, bias_pmodel_diff_corr_I, bias_pmodel_diff_corr_IV, bias_pmodel_diff_corr_III ) %>%
                              gather( fct, pmodel, bias_pmodel_diff_corr_I, bias_pmodel_diff_corr_IV, bias_pmodel_diff_corr_III )

modis <- df_dday_8d_agg %>%  select( mysitename, date, inbin, bias_modis_diff_corr_I, bias_modis_diff_corr_IV, bias_modis_diff_corr_III ) %>%
                             gather( fct, modis, bias_modis_diff_corr_I, bias_modis_diff_corr_IV, bias_modis_diff_corr_III )

vpm <- df_dday_8d_agg %>%  select( mysitename, date, inbin, bias_vpm_diff_corr_I, bias_vpm_diff_corr_IV, bias_vpm_diff_corr_III ) %>%
                           gather( fct, vpm, bias_vpm_diff_corr_I, bias_vpm_diff_corr_IV, bias_vpm_diff_corr_III )

bess_v1 <- df_dday_8d_agg %>%  select( mysitename, date, inbin, bias_bess_v1_diff_corr_I, bias_bess_v1_diff_corr_IV, bias_bess_v1_diff_corr_III ) %>%
                               gather( fct, bess_v1, bias_bess_v1_diff_corr_I, bias_bess_v1_diff_corr_IV, bias_bess_v1_diff_corr_III )

## Corrected by estimated fLUE (following approach II)

## pmodel
boxplot( pmodel ~ inbin, data=pmodel, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "P-model, norm., corr. pooled", line=0.5, adj = 0, font=2 )

## MODIS
boxplot( modis ~ inbin, data=modis, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "MODIS, norm., corr. pooled", line=0.5, adj = 0, font=2 )

## vpm
boxplot( vpm ~ inbin, data=vpm, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "VPM, norm., corr. pooled", line=0.5, adj = 0, font=2 )

## bess_v1
boxplot( bess_v1 ~ inbin, data=bess_v1, xlab = "fLUE bin", ylab = "bias (mod.-obs.)", outline=FALSE, ylim=c(-6,6) )
abline( h=0, lty=3 )
mtext( "BESS, norm., corr. pooled", line=0.5, adj = 0, font=2 )
```



### Corrected, by stress function, pooled models
Now, let's pool data (ratio observed over modelled) from all RS-models and check how the different approaches (I-III) perform in resolving the systematic bias.
```{r}
##------------------------------------------------
## Treat all different model's data as one - gather data
##------------------------------------------------
tmp  <- df_dday_8d_agg %>%  select( mysitename, date, fvar, inbin, bias_modis_diff, bias_vpm_diff, bias_bess_v1_diff, bias_pmodel_diff) %>% 
                            gather( model, bias_diff, bias_modis_diff, bias_vpm_diff, bias_bess_v1_diff, bias_pmodel_diff )

tmp0 <- df_dday_8d_agg %>%  select( mysitename, date, fvar, inbin, bias_modis_diff_corr, bias_vpm_diff_corr, bias_bess_v1_diff_corr, bias_pmodel_diff_corr ) %>% 
                            gather( model, bias_diff_corr, bias_modis_diff_corr, bias_vpm_diff_corr, bias_bess_v1_diff_corr, bias_pmodel_diff_corr )

tmp1 <- df_dday_8d_agg %>%  select( mysitename, date, fvar, inbin, bias_modis_diff_corr_I, bias_vpm_diff_corr_I, bias_bess_v1_diff_corr_I, bias_pmodel_diff_corr_I ) %>% 
                            gather( model, bias_diff_corr_I, bias_modis_diff_corr_I, bias_vpm_diff_corr_I, bias_bess_v1_diff_corr_I, bias_pmodel_diff_corr_I )

tmp2 <- df_dday_8d_agg %>%  select( mysitename, date, fvar, inbin, bias_modis_diff_corr_IV, bias_vpm_diff_corr_IV, bias_bess_v1_diff_corr_IV, bias_pmodel_diff_corr_IV ) %>% 
                            gather( model, bias_diff_corr_II, bias_modis_diff_corr_IV, bias_vpm_diff_corr_IV, bias_bess_v1_diff_corr_IV, bias_pmodel_diff_corr_IV )

tmp3 <- df_dday_8d_agg %>%  select( mysitename, date, fvar, inbin, bias_modis_diff_corr_III, bias_vpm_diff_corr_III, bias_bess_v1_diff_corr_III, bias_pmodel_diff_corr_III ) %>% 
                            gather( model, bias_diff_corr_III, bias_modis_diff_corr_III, bias_vpm_diff_corr_III, bias_bess_v1_diff_corr_III, bias_pmodel_diff_corr_III )

tmp4 <- df_dday_8d_agg %>%  select( mysitename, date, fvar, inbin, bias_modis_diff_corr_IV, bias_vpm_diff_corr_IV, bias_bess_v1_diff_corr_IV, bias_pmodel_diff_corr_IV ) %>% 
                            gather( model, bias_diff_corr_IV, bias_modis_diff_corr_IV, bias_vpm_diff_corr_IV, bias_bess_v1_diff_corr_IV, bias_pmodel_diff_corr_IV )

tmp5 <- df_dday_8d_agg %>%  select( mysitename, date, fvar, inbin, bias_modis_diff_corr_V, bias_vpm_diff_corr_V, bias_bess_v1_diff_corr_V, bias_pmodel_diff_corr_V ) %>% 
                            gather( model, bias_diff_corr_V, bias_modis_diff_corr_V, bias_vpm_diff_corr_V, bias_bess_v1_diff_corr_V, bias_pmodel_diff_corr_V )

##------------------------------------------------
## Quick plots IV:
##------------------------------------------------
par(las=1)
boxplot( bias_diff ~ inbin, data = tmp, outline=FALSE, ylim=c(-7,7), xlab = "fLUE bin", ylab = "ratio obs./mod." )
abline( h=0, lty=3 )
mtext( "Pooled models, normalised", line=0.5, adj = 0, font=2 )

boxplot( bias_diff_corr ~ inbin, data = tmp0, outline=FALSE, ylim=c(-7,7), xlab = "fLUE bin", ylab = "ratio obs./mod." )
abline( h=0, lty=3 )
mtext( "Pooled models, norm., corr. fLUE", line=0.5, adj = 0, font=2 )

boxplot( bias_diff_corr_I ~ inbin, data = tmp1, outline=FALSE, ylim=c(-7,7), xlab = "fLUE bin", ylab = "ratio obs./mod." )
abline( h=0, lty=3 )
mtext( "Pooled models, norm., corr. I", line=0.5, adj = 0, font=2 )

boxplot( bias_diff_corr_II ~ inbin, data = tmp2, outline=FALSE, ylim=c(-7,7), xlab = "fLUE bin", ylab = "ratio obs./mod." )
abline( h=0, lty=3 )
mtext( "Pooled models, norm., corr. II", line=0.5, adj = 0, font=2 )

boxplot( bias_diff_corr_III ~ inbin, data = tmp3, outline=FALSE, ylim=c(-7,7), xlab = "fLUE bin", ylab = "ratio obs./mod." )
abline( h=0, lty=3 )
mtext( "Pooled models, norm., corr. III", line=0.5, adj = 0, font=2 )

boxplot( bias_diff_corr_IV ~ inbin, data = tmp4, outline=FALSE, ylim=c(-7,7), xlab = "fLUE bin", ylab = "ratio obs./mod." )
abline( h=0, lty=3 )
mtext( "Pooled models, norm., corr. IV", line=0.5, adj = 0, font=2 )

boxplot( bias_diff_corr_V ~ inbin, data = tmp5, outline=FALSE, ylim=c(-7,7), xlab = "fLUE bin", ylab = "ratio obs./mod." )
abline( h=0, lty=3 )
mtext( "Pooled models, norm., corr. V", line=0.5, adj = 0, font=2 )
```

### Corrected, pooled models and stress function


```{r}
# pmodel <- df_dday_8d_agg %>%  select( mysitename, date, inbin, bias_pmodel_diff_corr_I, bias_pmodel_diff_corr_IV, bias_pmodel_diff_corr_III ) %>%
#                               gather( fct, pmodel, bias_pmodel_diff_corr_I, bias_pmodel_diff_corr_IV, bias_pmodel_diff_corr_III )

# modis <- df_dday_8d_agg %>%  select( mysitename, date, inbin, bias_modis_diff_corr_I, bias_modis_diff_corr_IV, bias_modis_diff_corr_III ) %>%
#                              gather( fct, modis, bias_modis_diff_corr_I, bias_modis_diff_corr_IV, bias_modis_diff_corr_III )

# vpm <- df_dday_8d_agg %>%  select( mysitename, date, inbin, bias_vpm_diff_corr_I, bias_vpm_diff_corr_IV, bias_vpm_diff_corr_III ) %>%
#                            gather( fct, vpm, bias_vpm_diff_corr_I, bias_vpm_diff_corr_IV, bias_vpm_diff_corr_III )

# bess_v1 <- df_dday_8d_agg %>%  select( mysitename, date, inbin, bias_bess_v1_diff_corr_I, bias_bess_v1_diff_corr_IV, bias_bess_v1_diff_corr_III ) %>%
#                                gather( fct, bess_v1, bias_bess_v1_diff_corr_I, bias_bess_v1_diff_corr_IV, bias_bess_v1_diff_corr_III )

pooled <- select( pmodel, -fct, bias=pmodel ) %>% 
          bind_rows( select( modis, -fct, bias=modis) ) %>% 
          bind_rows( select( vpm, -fct, bias=vpm) ) %>% 
          bind_rows( select( bess_v1, -fct, bias=bess_v1) )

##------------------------------------------------
## Quick plots V:
##------------------------------------------------
par(las=1)
boxplot( bias_diff ~ inbin, data = tmp, outline=FALSE, ylim=c(-7,7), xlab = "fLUE bin", ylab = "ratio obs./mod." )
abline( h=0, lty=3 )
mtext( "Pooled models, normalised", line=0.5, adj = 0, font=2 )

boxplot( bias_diff_corr ~ inbin, data = tmp0, outline=FALSE, ylim=c(-7,7), xlab = "fLUE bin", ylab = "ratio obs./mod." )
abline( h=0, lty=3 )
mtext( "Pooled models, norm., corr. fLUE", line=0.5, adj = 0, font=2 )

boxplot( bias ~ inbin, data = pooled, outline=FALSE, ylim=c(-7,7), xlab = "fLUE bin", ylab = "ratio obs./mod." )
abline( h=0, lty=3 )
mtext( "Pooled models, norm., pooled corr.", line=0.5, adj = 0, font=2 )
```

<!-- ## **Implications** -->

<!-- After deriving an empirical correction function to remove the bias in the P-model during dry soil conditions, I applied this function (with $a$ and $b$ fitted using approach II) for global P-model simulations. Two simulations were carried out: -->

<!-- - `s0`: no additional soil moisture stress on GPP considered (original model version) -->
<!-- - `s1a`: with additional soil moisture stress, following parametrisation I -->
<!-- - `s1b`: with additional soil moisture stress, following parametrisation II -->
<!-- - `s1c`: with additional soil moisture stress, following parametrisation III -->

<!-- Using P-model results, I am visualising the soil moisture effects on the mean GPP and its interannual variability. -->

<!-- ### Processing output files. -->
<!-- The following bash script uses CDO commands to derive statistics (mean, variance, relative variance) at the global and at the gridcell levels. -->
<!-- ```{r, eval=FALSE} -->
<!-- system( "./proc_nc_fields.sh" ) -->
<!-- ``` -->

<!-- ### Soil moisture reduction of mean annual GPP -->

<!-- ```{r map_effects_gpp_mean, echo=FALSE, warning=FALSE, message=FALSE} -->
<!-- source("map_effects_gpp_mean.R") -->
<!-- ``` -->

<!-- ### Soil moisture effect on variance in annual GPP -->
<!-- ```{r map_effects_gpp_var, echo=FALSE, warning=FALSE, message=FALSE} -->
<!-- source("map_effects_gpp_var.R") -->
<!-- ``` -->

<!-- ### Soil moisture effect on relative variance in annual GPP -->
<!-- Relative variance is the absolute variance divided by the mean. I'm quantifying the **amplification factor** ($A$) of the relative variance in annual GPP, quantified as: -->
<!-- $$ -->
<!-- A=\frac{\text{var}(GPP_{s1})\;\overline{GPP_{s0}}}{\text{var}(GPP_{s0})\;\overline{GPP_{s1}}} -->
<!-- $$ -->
<!-- ```{r map_effects_gpp_relvar, echo=FALSE, warning=FALSE, message=FALSE} -->
<!-- source("map_effects_gpp_relvar.R") -->
<!-- ``` -->

<!-- This shows that... -->

<!-- - Soil moisture effects on light use efficiency substantially reduce annual GPP. At the global level this is by around 15%. -->
<!-- - Additionally accounting for soil moisture limitation drastically increases the relative variance of annual GPP at the gridcell level. Below are the quantiles of the amplification factor of relative variance, shown also on the map above (see inset: empirical cumulative distribution function of the amplification factor on log scale axes). -->

<!-- - Accounting for soil moisture effects increases variability in annual GPP especially in semi-arid regions. These are the dominant drivers of carbon cycle variability at global and annual scales. How is global variability affected? (see below) -->

<!-- The mean amplification is: -->
<!-- ```{r echo=FALSE} -->
<!-- load("data/ampl_relvar.Rdata") -->
<!-- print( paste( mean( vec )) ) -->
<!-- ``` -->

<!-- The quantiles of the amplification factor are: -->
<!-- ```{r echo=FALSE} -->
<!-- print( quantile( vec, probs=( c(0.5,0.75, 0.9, 0.95, 0.99, 0.999 ) ) ) ) -->
<!-- ``` -->
<!-- This is also illustrated by the inset in the previous plot which shows the empirical cumulative distribution function of the amplification factor $A$. -->

<!-- ### Implications for IAV of global GPP -->
<!-- Next, I'm assessing the effect of the soil moisture correction for interannual variability in GPP. Analysis shown above shows that the at the gridcell level, variance in annual GPP is substantially enhanced by soil moisture effects. Does this translate into an enhancement of the variance in global GPP? -->

<!-- Here, using the P-model, $A$ at the global scale is calculated to be: -->
<!-- ```{r echo=FALSE} -->
<!-- nc <- nc_open( paste0( myhome, "/data/pmodel_fortran_output/gpp_pmodel_s0_RELVAR_GLOB.nc" ) ) -->
<!-- relvar_s0 <- ncvar_get( nc, varid="gpp" ) -->
<!-- nc_close(nc) -->

<!-- nc <- nc_open( paste0( myhome, "/data/pmodel_fortran_output/gpp_pmodel_s1_RELVAR_GLOB.nc" ) ) -->
<!-- relvar_s1 <- ncvar_get( nc, varid="gpp" ) -->
<!-- nc_close(nc) -->

<!-- print(relvar_s1/relvar_s0) -->
<!-- ``` -->
<!-- Hence, the relative variance (variance in global total annual GPP divided by its mean) does not increase. The contrary is the case: it even decreases slightly. How can this be understood? The suspicion is that this is the scale dependence, also found by Jung et al. (2017). This is investigated below. -->

<!-- #### Ahlstroem plot -->
<!-- First analysis, I quantified the "Ahlstroem-f" (see Eq. 1 in Ahlstroem et al., 2015). This index quantifies for each gridcell its contribution to global interannual variability. If it's positive, then the gridcell's variability is in sync with global anomalies, i.e. has a positive contribution to global anomalies - the bigger the value the bigger its contribution. If positive and negative values are equally frequent and big, they cancel each other out, leaving zero global interannual variability. It is defined as: -->
<!-- $$ -->
<!-- f_j = \frac{\sum_t \frac{x_{jt}|X_t|}{X_t}}{\sum_t |X_t|} -->
<!-- $$ -->
<!-- where $x_{jt}$ is the flux anomaly (departure from a long-term trend) for region $j$ at time $t$ (in years), and $X_t$ is the global flux anomaly, so that $X_t=\sum_j x_{jt}$. By this definition $f_j$ is the average relative anomaly $x_{jt}/X_t$ for region $j$, weighted with the absolute global anomaly $|X_t|$ (text copied from Ahlstroem et al., 2015). -->

<!-- Here, the flux anomaly $x_{jt}$ is the diference in detrended GPP from simulations `s1` and `s0`: -->
<!-- $$ -->
<!-- x_{jt} = \Delta\text{GPP}_{s0} - \Delta\text{GPP}_{s1} -->
<!-- $$ -->
<!-- where $\Delta\text{GPP}$ the annual anomaly from its mean linear trend over 1982-2011. -->

<!-- ```{r plot_ahlstroem, warning=FALSE, message=FALSE} -->
<!-- source("plot_ahlstroem.R") -->
<!-- ``` -->

<!-- This shows that Australia, sub-tropical southern Africa, and other red-colored regions are counteracted by blue-colored regions. Regional responses are becoming decoupledat scales of 10-20 degrees. This becomes even more evident by the analysis below: -->

<!-- #### Jung plot -->
<!-- To look at the spatial scale-dependence of the amplification factor, I did a similar analysis as in Jung et al. (2017). -->

<!-- First, create grid definition files for remapping with CDO. These are stored in `./grids/` as text files. -->
<!-- ```{r do_jung, warning=FALSE, eval=FALSE, message=FALSE, echo = FALSE} -->
<!-- source("define_grids.R") -->
<!-- source("regrid_jung.R") -->
<!-- ``` -->

<!-- Then evaluate the amplification of relative variance of annual GPP as a function of spatial resolution. -->
<!-- ```{r plot_jung, warning=FALSE, message=FALSE} -->
<!-- source("plot_jung.R") -->
<!-- ``` -->

<!-- This figure shows the amplification factor with the solid line as the mean, and shaded areas as the 1%/99%, 5%/95%, 10%/90%, and 25%/75% quantile ranges. Apparently, **the soil moisture-related amplification of relative variance in annual GPP is scale dependent.** (I'll have to think of more human-friendly words to describe this result). The bias of common remote-sensing based GPP estimates under dry conditions does not translate into an underestimation of the IAV of global GPP. However, at the smaller scales, IAV is drastically underestimated when not accounting for soil moisture effects. -->

<!-- For most gridcells (within the lower and upper quartiles), the amplification factor only starts to decline around 20 degrees. This reflects the spatial scale of the patterns in the Ahlstroem plot above. -->

## Additional analyses

![*Bias versus soil moisture, normalised to bias in the wettest soil moisture bin*](fig/bias_vs_fvar_boxes_soilm_pmodel.pdf)


<!-- <!-- ### Distribution of variance in annual GPP --> -->
<!-- <!-- Considering that the remote-sensing driven GPP models (below termed RS-models) have a commong high bias related to soil moisture effects on LUE, I expected that these models should also have a tendency to underestimate variability at the gridcell level. But what's the reference? I compared them to DGVMs from the TRENDY bunch. --> -->

<!-- <!-- Below, I'm plotting the distribution of gridcell-level variance and relative variance in annual GPP for different models. 30-year time series are available from the P-model (driven by fAPAR) and the two MTE products, and for the TRENDY models. For other RS-models (MOD17AH2, BESS, VPM), only 10 year time series are evaluated, but the general picture is the same.   --> -->
<!-- <!-- ```{r plot_gridcell_iav, warning=FALSE, message=FALSE} --> -->
<!-- <!-- source("plot_gridcell_iav.R") --> -->
<!-- <!-- ``` --> -->

<!-- <!-- The comparison of the P-model to other RS-models and to TRENDY DGVMs doesn't give a clear picture: --> -->

<!-- <!-- - The difference between P-model `s0` and `s1` doesn't look impressive in this plot (logarithmic x-axis!). --> -->
<!-- <!-- - P-model has a much higher variance (absolute and relative) in gridcell-level annual GPP than the two MTE products and BESS, but looks very similar to MOD17AH2 (that's the latest MODIS GPP) and VPM. However, note that MTE FLUXCOM has a variance that is about 2 orders of magnitude smaller than all the other's. BESS and MTE about one order of magnitude smaller. Huge discrepancies! --> -->
<!-- <!-- - Compared to TRENDY models, relative variance in the P-model middle-of-the-road, but the spread between models is very large (>1 order of magnitude). Moving from `s0` to `s1` (= additionally accounting for soil moisture limitation) induces a smaller change in relative variance than the order of the model spread. DGVMs don't really serve us here helping to discriminate whether accounting for the soil moisture effect moves the P-model (as a representant of RS-models) to a more realistic range (considering that DGVMs do acccount for soil moisture limitation and should therefore be more realistic). --> -->

<!-- <!-- I'm a bit unsre if and if so how I should use these results. But anyhow, the effort of looking into this wasn't in vain. It lead me on to another track, wich I will let you know about asap... --> -->

<!-- <!-- ### Extreme events --> -->
<!-- <!-- Accounting for the soil moisture effect should also affect the distribution of extreme events. With negative GPP extremes that are related to drought becoming more negative (additional GPP reduction by soil moisture), the tails of the distribution may get fatter. On the other hand, smaller events, otherwise not detected/simulated may be more frequent. --> -->

<!-- <!-- We applied Jakob's method to identify contingent GPP anomalies in time and space as extreme events. A binary 3D field (space x time) is defined with *true* for points where the GPP anomaly is in the lower 5% quantile w.r.t. the distribution of all values in space and time. The integral of these anomalies across contingent regions in space-time quantify extremes as the GPP "loss" in units of PgC yr$^{-1}$. We derived the distribution of these extremes using monthly aggregated outputs from the two P-model simulations.  --> -->

<!-- <!-- While the question at hand here sounds highly exciting, the results are not. The difference between the distribution is not that big. The top 20-or-so events are a bit bigger in the `s1` simulation (however, the top 1 and 2 events are bigger in the `s0` simulation). --> -->
<!-- <!-- ![](fig/extremes.pdf) --> -->


<!-- <!-- The gridcell-level change in variance shown by maps above should be clearly visible in its distribution function. Also at this scale, P-model suggests a much higher variability than MTE GPP. And again, the TRENDY model don't allow us to argue that when including soil moisture stress, we get closer to a (realistic) DGVM with a satellite-driven GPP estimate. There are some models out there that have an even larger variability than the P-model (e.g. LPJ-GUESS or LPX). I'm showing density plots with straight and with logarithmic axes. --> -->
<!-- <!-- ```{r plot_gridcell_iav, echo=FALSE, warning=FALSE} --> -->
<!-- <!-- source("plot_gridcell_iav.R") --> -->
<!-- <!-- ``` --> -->

<!-- <!-- In spite of the substantial amplification of variance in annual GPP at the gridcell level, the variance of *global* annual GPP is not affected by the soil moisture correction. --> -->

<!-- <!-- As shown in the figure below, adding the soil moisture limitation to the P-model (black dashed vs. black line) results in a wider distribution of annual GPP anomalies from the mean trend (a.k.a. interannual variability). MTE GPP has a much narrower distribution. Comparison to TRENDY models is not so clear: Some models have a very small interannual variability, some have a large one, comparable to P-model. However, it looks like the P-model has the largest IAV. I guess we cannot really constrain these global total GPP IAV values with (global scale) observations, can we? --> -->

<!-- <!-- ```{r plot_global_iav, echo=FALSE, warning=FALSE} --> -->
<!-- <!-- source("plot_global_iav.R") --> -->
<!-- <!-- ``` --> -->


<!-- <!-- This is due to counteracting contributions from different regions. --> -->
