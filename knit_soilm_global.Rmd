---
title: "SOILM_GLOBAL"
author: "Beni Stocker"
date: "10/26/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r eval=FALSE}
mycurve <- function( func, from, to, col='black', add=FALSE, lwd=1, lty=1 ){
  range_x <- seq( from, to, by=(to-from)/100 )
  range_y <- sapply( range_x, func )
  if (add){
    lines( range_x, range_y, type="l", col=col, lwd=lwd, lty=lty )
  } else {
    plot( range_x, range_y, type="l", col=col, lwd=lwd, lty=lty )
  }
}

```
# SOILM_GLOBAL

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

## Aggregate site data

Collect and aggregate FLUXNET 2015 site scale data to single data frame, using all sites. Aggregation is done for daily data using P-model output and observational data, and for 8-day periods using MTE and MODIS data, combined with observational data (mean over 8-day period)
```{r aggregate_all, warning=FALSE}
source("aggregate_all_fluxnet2015.R")
```

### Indication of a bias under dry conditions
The following boxplots give an indication that GPP model biases are related to drought conditions: Under dry conditions (daily AET/PET<0.95), the models exhibit a higher bias (ratio of modelled over observed GPP). The P-model is unbiased under moist conditions. For both MTE and MODIS GPP the low bias under moist conditions is partially compensated by a high bias (or apparently small bias) under dry conditions. Furthermore, the P-model bias exhibits a relationship to AET/PET: the drier the higher bias. The same is true for MTE and MODIS GPP, although the pattern is not as clear.
```{r plot_all, fig.width=5, fig.height=4}
source("plot_agg_all_fluxnet2015.R")
```

Aggregate data as before but now only for a subset of sites where the NN-FLUXNET2015 method performed well. This data includes the NN-predicted values of LUE and fLUE.
```{r aggregate_nn, warning=FALSE}
source("aggregate_nn_fluxnet2015.R")
```

## Fit soil moisture stress function
Derive the soil moisture stress function by fitting a quadratic function to fLUE data derived by (NN FLUXNET2015). The maximum LUE decline at low soil moisture is a function of mean AET/PET (see Fig. 9 in Stocker et al. XXX). Two approaches are shown here. These yield very similar results.

### Two-step method
This approach is based on a linear fit between the maximum LUE reduction (mean fLUE values in lowest soil moisture bin fLUE$_0$) and mean annual AET/PET.
```{r linearfit, fig.width=4, fig.height=4}
load( "data/nice_nn_agg_lue_obs_evi.Rdata" )  # loads 'nice_agg'
ddf <- nice_agg; rm("nice_agg")  # rename to be a bit more concise
source("get_linearfit.R")
source("plot_linearfit.R")
linearfit <- get_linearfit( ddf, monthly=FALSE )
plot_linearfit( linearfit )
```

The fit is robust w.r.t. using daily or monthly data - i.e. coefficients are nearly identical:
```{r linearfit_monthly, fig.width=4, fig.height=4}
linearfit <- get_linearfit( ddf, monthly=TRUE )
plot_linearfit( linearfit )
```
Given fLUE$_0$ as a linear function of mean AET/PET, the soil moisture stress function can be calculated with 
```{r}
calc_flue_est_alpha <- function( x, alpha, apar, bpar, cpar, dpar ){
  flue0 <- apar + bpar * alpha
  beta  <- (flue0 - 1.0) / (cpar - dpar)^2
  flue_est <- beta * (x - dpar)^2 + 1
  return( flue_est )
}
linearfit <- get_linearfit( ddf, monthly=FALSE )
flue <- calc_flue_est_alpha( ddf$soilm_mean, alpha=ddf$meanalpha, apar=coef(linearfit$linmod)[1], bpar=coef(linearfit$linmod)[2], cpar=0.125, dpar=0.75 )
```

### Non-linear least squares
This approach allows the linear relationship between mean AET/PET and the maximum LUE reduction to be freely determined from fitting a quadratic function to fLUE data. In addition to fitting the linear function of fLUE$_0$, here also the "tie-points" are fitted. Fitting is done using the `nlsLM` function of the `minpack.lm` package as follows:
```{r nlsfit, eval=FALSE}
nlsfit <- nlsLM( 
                fvar ~ calc_flue_est_alpha( soilm_mean, meanalpha, apar, bpar, cpar, dpar ),
                data=df,
                start=list( apar=0.11, bpar=0.89, cpar=0.125, dpar=0.75 ),
                lower=c( apar=0.001, bpar=0.5, cpar=0.001, dpar=0.3 ),
                upper=c( apar=0.3, bpar=1.5, cpar=0.3, dpar=1.0 ),
                algorithm="port"
                ) 
```
Get the fit using daily data by:
```{r get_nlsfit}
source("get_nlsfit.R")
nlsfit <- get_nlsfit( ddf, monthly=FALSE )
print("fitted coefficients are:")
print(coef(nlsfit))
```
This method yields an almost identical relationship between maximum LUE reduction and mean AET/PET as the method described above (see red line and equation in plot below):
```{r plotnlsfit, fig.width=4, fig.height=4}
plot_linearfit( linearfit, nlsfit=nlsfit )
```

The two methods for estimating fLUE perform nearly equally well. 

```{r plot_flue_est, fig.width=4, fig.height=4, echo=FALSE}
source("compl_df_flue_est.R")
ddf <- compl_df_flue_est( ddf, linearfit, nlsfit )
rmse <- with( ddf, sqrt( mean( (flue_est-fvar)^2 , na.rm = TRUE ) ) )
with( ddf, plot( fvar, flue_est, pch=16, col=rgb(0,0,0,0.1), las=1, xlim=c(-0.5, 2), ylim=c(0.2, 1) ) )
lines( c(-100,100), c(-100,100), lty=3, col="red" )
mtext( paste( "RMSE =", format( rmse, digits = 5 ), sep="" ), adj=0.03, cex=1, line=-2, col="red" )

rmse <- with( ddf, sqrt( mean( (flue_est_nls-fvar)^2 , na.rm = TRUE ) ) )
with( ddf, plot( fvar, flue_est_nls, pch=16, col=rgb(0,0,0,0.1), las=1, xlim=c(-0.5, 2), ylim=c(0.2, 1) ) )
lines( c(-100,100), c(-100,100), lty=3, col="red" )
mtext( paste( "RMSE =", format( rmse, digits = 5 ), sep="" ), adj=0.03, cex=1, line=-2, col="red" )
```

### Estimate fLUE
Now that the two fitting functions are defined, we can estimate fLUE values as a function of soil moisture. The following figures illustrate daily fLUE values derived by Stocker et al. XXX and the fitted quadratic functions using the two step method (red) and the NLS method (green).
```{r plot_flue_allsites, fig.width=4, fig.height=3, echo=FALSE}
for ( sitename in unique(ddf$mysitename) ){
  with( filter(ddf, mysitename==sitename),
        plot(
              soilm_mean, 
              fvar,
              pch=16,
              col=rgb(0,0,1,0.6),
              main=sitename,
              ylim=c(0,1.4),
              xlim=c(0,1),
              xlab="soil water content (fraction)",
              ylab="fLUE"            
              )
        )
  abline( h=1.0, lty=3 )
  meanalpha <- filter(ddf, mysitename==sitename)$meanalpha[1]
  mycurve( function(x) calc_flue_est_alpha( x, meanalpha, apar=coef(linearfit$linmod)[1], bpar=coef(linearfit$linmod)[2], cpar=0.125, dpar=0.75 ), from=0.0, to=1.0, col='red', add=TRUE, lwd=2 )
  mycurve( function(x) calc_flue_est_alpha( x, meanalpha, apar=coef(nlsfit)[[ "apar" ]], bpar=coef(nlsfit)[[ "bpar" ]], cpar=coef(nlsfit)[[ "cpar" ]], dpar=coef(nlsfit)[[ "dpar" ]] ), from=0.0, to=1.0, col='green', add=TRUE, lwd=2 )
}
```

Finally, all dataframes are complemented with estimated fLUE (columns `flue_est` and `flue_est_nls`).
```{r complement_flue}
source("complement_all.R")
# complment_all( linearfit, nlsfit )
```

## Reshape data to align by drought events
```{r}
# source("execute_reshape_align_nn_fluxnet2015.R")
```

## Plot data to analyse bias, related to drought effect on LUE
```{r}
# source("plot_agg_nn_fluxnet2015.R")
```

<!-- -->

<!-- 1. Define relationship between fLUE_0 and annual mean AET/PET -->
<!-- ```{r flue_0} -->
<!-- source("get_function_fvar_vs_soilm.R") -->
<!-- ``` -->

<!-- 2. Define correction function (function of soil moisture) for each site -->
<!-- ```{r correctionfunction, eval=FALSE} -->
<!-- source("xxx.R") -->
<!-- ``` -->

<!-- 3. Apply function to estimate fLUE -->
<!-- ```{r, eval=FALSE} -->
<!-- source("xxx.R") -->
<!-- ``` -->

<!-- 4. Calculate corrected GPP -->
<!-- ```{r, eval=FALSE} -->
<!-- source("xxx.R") -->
<!-- ``` -->

<!-- ## Align data by drought events (dbt whether necessary -> check ratio vs. fLUE plot) -->

<!-- ## Plot bias versus dryness -->

<!-- ## in R, get IAV (distribution across gridcells) of P-model before and after soil moisture correction, MODIS GPP, MTE GPP, TRENDY models -->

<!-- ### Process TRENDY outputs -->

<!-- 1. Subset years 1982-2015 -->
<!-- Using CDO: -->
<!-- ```{sh} -->
<!-- cdo selyear,1982/2015 CABLE-POP_S2_gpp.nc CABLE-POP_S2_gpp_sub.nc -->
<!-- cdo selyear,1982/2015 CLASS-CTEM_S2_gpp.nc CLASS-CTEM_S2_gpp_sub.nc -->
<!-- cdo selyear,1982/2015 CLM4.5_S2_gpp.nc CLM4.5_S2_gpp_sub.nc -->
<!-- cdo selyear,1982/2015 ISAM_S2_gpp.nc ISAM_S2_gpp_sub.nc -->
<!-- cdo selyear,1982/2015 JSBACH_S2_gpp.nc JSBACH_S2_gpp_sub.nc -->
<!-- cdo selyear,1982/2015 LPJ-GUESS_S2_gpp_fEst_sub.nc LPJ-GUESS_S2_gpp_fEst.nc -->
<!-- cdo selyear,1982/2015 VEGAS_S2_gpp_sub.nc VEGAS_S2_gpp.nc -->
<!-- cdo selyear,1982/2015 VISIT_S2_gpp.nc VISIT_S2_gpp_sub.nc -->
<!-- ``` -->

<!-- Using R for problematic files: -->
<!-- ```{r} -->
<!-- source("selyears_dlem.R") -->
<!-- source("selyears_jules.R") -->
<!-- source("selyears_lpx.R") -->
<!-- source("selyears_orchidee.R") -->
<!-- source("selyears_sdgvm.R") -->
<!-- ``` -->

<!-- Using Ferret for JULES. In Ferret: -->
<!-- ``` -->
<!-- go selyears_jules.jnl -->
<!-- ``` -->

<!-- In Bash: -->
<!-- ```{sh} -->
<!-- cdo chname,GPP_SUB,gpp CRU-NCEP_1p1.update.vn4.6.S2.Annual.gpp_sub.nc tmp.nc -->
<!-- mv tmp.nc CRU-NCEP_1p1.update.vn4.6.S2.Annual.gpp_sub.nc -->

<!-- cdo chname,gpp.monthly,gpp /Users/benjaminstocker/data/trendy/v5/LPJ-GUESS/S2/LPJ-GUESS_S2_gpp_fEst_sub.nc tmp.nc -->
<!-- mv tmp.nc /Users/benjaminstocker/data/trendy/v5/LPJ-GUESS/S2/LPJ-GUESS_S2_gpp_fEst_sub.nc -->
<!-- ``` -->

<!-- 2. Converting to annual totals: -->
<!-- ```{r} -->
<!-- source("get_ann_trendy.R") -->
<!-- ``` -->

<!-- 3. Detrend, and calculate variance and relative variance -->
<!-- ```{r} -->
<!-- source("get_iavtrendy.R") -->
<!-- ``` -->


<!-- ## in R/cdo: plot average relative IAV increase due to soil moisture effect as a function of spatial scale (as in Jung) -->
<!-- ## in R Ahlstroem plot -->

<!-- You can also embed plots, for example: -->

<!-- ```{r pressure, echo=FALSE} -->
<!-- plot(pressure) -->
<!-- ``` -->

<!-- Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot. --> -->
